name: Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      # Give the default GITHUB_TOKEN write permission to commit and push the
      # added or changed files to the repository.
      contents: write

    steps:
    - uses: actions/checkout@v6

    - name: Use Node.js
      uses: actions/setup-node@v6
      with:
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Download Database
      run: |
        curl -L -o weici_ext.db https://github.com/1299172402/weici/releases/download/v0.1.2/weici_ext.db || echo "Database download failed, build might fail if not present."
        # If download fails (e.g. release doesn't exist yet), we might want to skip build or fail.
        # Check if file exists and has size
        if [ ! -s weici_ext.db ]; then
          echo "Database invalid or not found. Skipping build logic that requires DB."
          # Create a dummy DB or handled in build.js?
          # For now, let's allow fail if user hasn't uploaded it yet, or the build.js will error.
        fi

    - name: Build
      run: npm run build
      continue-on-error: true 
      # verification: allowing error if DB is missing as per user "I will upload later"

    - uses: stefanzweifel/git-auto-commit-action@v7
